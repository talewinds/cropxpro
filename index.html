<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>StickerGen AI â€” Create WhatsApp & Instagram Stickers (Cartoon, Text, Emoji)</title>

  [cite_start]<meta name="description" content="StickerGen AI instantly converts your photos into shareable WhatsApp & Instagram stickers â€” AI cartoonify with transparent PNG export, text & emoji overlays, and sticker-pack downloads. Client-side fallback ensures fast, private processing." [cite: 1, 2]/>
  [cite_start]<meta name="keywords" content="sticker maker, whatsapp stickers, instagram stickers, cartoonify photo, transparent png, AI sticker, webp, sticker pack" [cite: 2]/>
  <link rel="canonical" href="https://www.example.com/" />

  <meta property="og:title" content="StickerGen AI â€” Create WhatsApp Stickers" />
  [cite_start]<meta property="og:description" content="Turn your photos into shareable cartoon stickers. Transparent PNG, text & emoji overlays, sticker packs. No image storage." [cite: 3]/>
  <meta property="og:image" content="https://www.example.com/og-image.png" />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://www.example.com/" />

  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="StickerGen AI â€” Create WhatsApp Stickers" />
  [cite_start]<meta name="twitter:description" content="Turn photos into sticker-ready transparent PNGs with AI or client-side cartoonifier. Free and private." [cite: 4]/>
  <meta name="twitter:image" content="https://www.example.com/og-image.png" />

  <meta name="robots" content="index,follow" />

  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@graph": [
      {
        "@type": "Organization",
        "name": "StickerGen AI",
        "url": "https://www.example.com/",
        "logo": "https://www.example.com/logo.png",
        "sameAs": []
      },
   
    {
        "@type": "WebSite",
        "url": "https://www.example.com/",
        "name": "StickerGen AI",
        [cite_start]"description": "Create AI cartoon stickers and text/emoji overlays for WhatsApp & Instagram." [cite: 5, 6]},
      {
        "@type": "SoftwareApplication",
        "name": "StickerGen AI",
        "operatingSystem": "Web",
        "applicationCategory": "GraphicsApplication",
        [cite_start]"description": "Web-based sticker maker that cartoonifies photos, removes background, and exports transparent PNG stickers." [cite: 7]},
      {
        "@type": "FAQPage",
        "mainEntity": [
          [cite_start]{ "@type": "Question", "name": "Does StickerGen save my photos?", "acceptedAnswer": { "@type": "Answer", "text": "No â€” images are processed client-side where possible and not stored permanently. If you enable server AI, ensure your provider's policy meets your privacy needs." [cite: 8] } },
          [cite_start]{ "@type": "Question", "name": "Which file types are supported?", "acceptedAnswer": { "@type": "Answer", "text": "PNG, JPEG/JPG and WebP are supported." [cite: 9] } }
        ]
      }
    ]
  }
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js" integrity="sha512-j6P/8o4HnOQ5pKc1uM3u1z8zrH6V7gYQHc6Bz1w1lC1mFfM6a3sZq+Jp/5lX0r3f0Ykzktm7ERkF7u6dVx7xA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    :root{
      [cite_start]--bg-1: linear-gradient(135deg,#fff7f0 0%, #f3f0ff 100%); [cite: 10]
      --accent-1: #ff6b6b;
      --accent-2: #6b8dff;
      --accent-3: #ffd166;
      --card-grad: linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.75));
      --glass: rgba(255,255,255,0.6);
    }

    [cite_start]html,body { height:100%; [cite: 11]
    }
    body {
      [cite_start]font-family: 'Inter', system-ui, -apple-system, "Helvetica Neue", Arial; [cite: 12]
      background: radial-gradient(circle at 10% 10%, rgba(255,107,107,0.06), transparent 10%),
                  radial-gradient(circle at 90% 90%, rgba(107,141,255,0.04), transparent 12%),
                  [cite_start]#f8fafc; [cite: 13]
      color: #07203a;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }

    /* container card */
    .card {
      [cite_start]background: var(--card-grad); [cite: 14]
      border: 1px solid rgba(15,23,42,0.04);
      box-shadow: 0 10px 30px rgba(8,20,60,0.07);
      border-radius: 16px;
    }

    [cite_start]header { padding: 22px 6px; [cite: 15]
      margin-bottom: 8px; }
    header h1 {
      font-size: 2.4rem;
      letter-spacing: -0.02em;
      [cite_start]background: linear-gradient(90deg, var(--accent-1), var(--accent-2)); [cite: 16]
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
      display:inline-block;
    }
    [cite_start]header p { color: #334155; [cite: 17]
      margin-top:6px; }

    /* Top ad styling */
    .ad-unit {
      [cite_start]border-radius: 14px; [cite: 18]
      background: linear-gradient(135deg, rgba(255,209,136,0.12), rgba(107,141,255,0.06));
      display:flex; align-items:center; justify-content:center;
      [cite_start]border: 1px dashed rgba(16,24,40,0.06); [cite: 19]
    }

    /* Controls column styling */
    .controls .label {
      [cite_start]color: #0f172a; [cite: 20]
      font-weight:600;
    }
    input[type="file"] { background: linear-gradient(90deg,#fff,#fff); }
    [cite_start].preview-box { height: 420px; border-radius: 12px; [cite: 21]
    }

    /* Make buttons colorful & animated */
    .btn-primary {
      [cite_start]background: linear-gradient(90deg,var(--accent-1),var(--accent-2)); [cite: 22]
      color: white;
      box-shadow: 0 8px 20px rgba(107,141,255,0.12);
      [cite_start]transition: transform .12s ease, box-shadow .12s ease; [cite: 23]
    }
    [cite_start].btn-primary:hover { transform: translateY(-3px); box-shadow: 0 12px 34px rgba(107,141,255,0.18); [cite: 24]
    }
    .btn-accent {
      background: linear-gradient(90deg,var(--accent-3),#ffd9a8);
      color: #07203a;
      font-weight:600;
      [cite_start]transition: transform .12s ease; [cite: 25]
    }
    .btn-accent:hover { transform: translateY(-2px); }

    /* Colorful small UI elements */
    .chip {
      [cite_start]display:inline-flex; [cite: 26]
      align-items:center; gap:8px;
      background: linear-gradient(90deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
      border-radius: 999px; padding:6px 10px; font-weight:600; color:#0b2545;
      [cite_start]border: 1px solid rgba(11,37,69,0.05); [cite: 27]
      box-shadow: 0 4px 14px rgba(11,37,69,0.04);
    }

    /* Make inputs pop */
    [cite_start]input, select, textarea { border-radius: 10px; [cite: 28]
      border: 1px solid rgba(15,23,42,0.06); padding:10px; background: rgba(255,255,255,0.9); }
    [cite_start]input:focus, textarea:focus { outline: none; [cite: 29]
      box-shadow: 0 6px 20px rgba(99,102,241,0.08); border-color: rgba(99,102,241,0.4); }

    /* Preview area */
    [cite_start].preview-box { background: linear-gradient(180deg,#ffffff,#fbfdff); [cite: 30]
      padding:14px; border: 1px solid rgba(15,23,42,0.03); }
    #stickerCanvas {
      [cite_start]width:100%; height:auto; max-width:560px; max-height:560px; [cite: 31]
      border-radius:12px;
      border: 6px solid rgba(255,255,255,0.9);
      box-shadow: 0 12px 40px rgba(15,23,42,0.06), inset 0 -2px 12px rgba(11,37,69,0.02);
      [cite_start]transition: transform .12s ease; [cite: 32]
    }

    #stickerCanvas:hover { transform: translateY(-4px) scale(1.01); }

    /* Status */
    [cite_start]#statusMessage { min-height: 20px; [cite: 33]
      color: #334155; }

    /* Fancy small text */
    [cite_start].muted { color:#64748b; font-size:0.92rem; [cite: 34]
    }

    /* Action buttons */
    [cite_start].action-row button { border-radius: 12px; padding:10px 12px; font-weight:700; [cite: 35]
    }

    .rounded-glow {
      position:relative;
      border-radius:14px;
      [cite_start]overflow:hidden; [cite: 36]
    }
    .rounded-glow:before {
      content:""; position:absolute; inset:0;
      background: linear-gradient(90deg, rgba(255,107,107,0.06), rgba(107,141,255,0.06));
      [cite_start]pointer-events:none; [cite: 37]
    }

    /* Footer cards */
    [cite_start]footer .card { padding:18px; [cite: 38]
    }

    /* Cookie consent styling improved */
    [cite_start].cookie-consent { position: fixed; left: 12px; [cite: 39]
      [cite_start]right: 12px; bottom: 12px; z-index: 9999; background: linear-gradient(90deg,#ffffff,#fffaf0); border-radius: 12px; padding: 12px; display:flex; align-items:center; gap:12px; border:1px solid rgba(11,37,69,0.06); [cite: 40]
      box-shadow: 0 12px 40px rgba(11,37,69,0.08); }

    /* Responsive tweaks */
    @media (max-width: 900px) {
      [cite_start]header h1 { font-size: 1.9rem; [cite: 41]
      }
      #stickerCanvas { max-width:420px; max-height:420px; border-width:5px; }
      [cite_start].preview-box { height:360px; [cite: 42]
      }
    }
  </style>
  </head>

<body class="p-4 md:p-8">
  <div class="container mx-auto max-w-6xl">
    <header class="text-center mb-6">
      <h1 class="text-4xl font-extrabold mb-1">ðŸš€ StickerGen AI</h1>
      <p class="text-gray-600 muted">Create WhatsApp & Instagram stickers in seconds â€” AI cartoonify, text & emoji overlays, transparent PNG export.</p>
    </header>

    <div class="ad-unit h-24 md:h-28 rounded-lg flex items-center justify-center mb-6 card">
     
    [cite_start][cite: 43]
      <div class="chip"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M4 12h16" stroke="#6b8dff" stroke-width="2" stroke-linecap="round"/></svg><span class="muted">AD SENSE UNIT TOP (728x90 / Adaptive)</span></div>
    </div>

    <div class="grid lg:grid-cols-3 gap-8">
      <div class="lg:col-span-1 card p-6 controls rounded-glow">
        <h2 class="text-2xl font-semibold mb-4">1 â€” Upload & Customize</h2>

        <label class="block text-sm font-medium text-gray-700 mb-2">Select 
[cite_start]an Image (PNG / JPG / WEBP)</label> [cite: 44]
        <input id="fileInput" type="file" accept="image/png,image/jpeg,image/webp" class="w-full text-sm mb-2" />
        <p id="fileNameDisplay" class="text-xs text-gray-500 italic mb-3">No file selected.</p>

        <div class="mb-3">
          <label class="text-sm font-medium text-gray-700">Sticker Type</label>
          <div class="flex gap-2 mt-2">
            <label class="flex items-center gap-2 p-2 rounded-lg cursor-pointer bg-gradient-to-r from-pink-50 to-blue-50 border border-transparent"><input name="stickerType" type="radio" value="cartoon" checked 
[cite_start]onchange="updateControls()" /> <span>âœ¨ AI Cartoon</span></label> [cite: 45]
            <label class="flex items-center gap-2 p-2 rounded-lg cursor-pointer bg-gradient-to-r from-amber-50 to-lime-50"><input name="stickerType" type="radio" value="text" onchange="updateControls()" /> <span>ðŸ’¬ Text</span></label>
            <label class="flex items-center gap-2 p-2 rounded-lg cursor-pointer bg-gradient-to-r from-rose-50 to-cyan-50"><input name="stickerType" type="radio" value="emoji" onchange="updateControls()" /> <span>ðŸ˜‚ Emoji</span></label>
          </div>
        </div>

        <div id="customizationSection" class="space-y-3 mb-4">
          <div 
[cite_start]id="textInputGroup" class="hidden"> [cite: 46]
            <label class="text-sm font-medium">Sticker Text (max 20 chars)</label>
            <input id="stickerText" maxlength="20" class="w-full p-2 border rounded-lg" placeholder="E.g., HELLO!"
[cite_start]/> [cite: 47]
            <label class="text-xs text-gray-500 mt-1">Short uppercase text works best.</label>
          </div>

          <div id="emojiInputGroup" class="hidden">
            <label class="text-sm font-medium">Emoji</label>
            <input id="stickerEmoji" maxlength="2" class="w-full p-2 border rounded-lg" placeholder="ðŸ”¥ or ðŸ˜Š" />
          </div>

          <div>
   
          [cite_start]<label class="text-sm font-medium">Scale</label> [cite: 48]
            <input id="scaleRange" type="range" min="0.6" max="1.4" step="0.01" value="1" class="w-full" />
            <div class="flex items-center gap-3 text-xs text-gray-600 mt-1">
              <label class="flex items-center gap-2"><input id="outlineToggle" type="checkbox" /> Outline</label>
              <label class="flex items-center gap-2 text-xs">Thickness <input id="outlineThickness" type="range" min="0" max="24" value="12" class="w-24" /></label>
    
          <label class="flex items-center gap-2 text-xs">
            <input id="polishToggle" type="checkbox" /> Polish
          </label>
          </div>
        </div>

        <div class="mb-4">
          <button id="generateBtn" onclick="prepareAndGenerate()" class="w-full py-3 font-bold btn-primary rounded-xl disabled:opacity-50 flex items-center justify-center gap-2">
            <svg id="generateIcon" class="w-5 h-5" viewBox="0 0 24 24" fill="none"><path stroke="white" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
            <svg id="loadingSpinner" class="animate-spin w-5 
[cite_start]h-5 hidden" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="white" stroke-width="4"></circle><path class="opacity-75" fill="white" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"></path></svg> [cite: 50]
            <span id="generateText">Generate Sticker</span>
          </button>

          <div class="my-3 bg-gradient-to-r from-white to-yellow-50 p-3 rounded-lg border border-yellow-100 text-center">
            <strong class="text-gray-600">AD SENSE (In-content) â€” paste 
[cite_start]AdSense code here</strong> [cite: 51]
          </div>

          <p id="statusMessage" class="text-center text-sm mt-2 muted h-6"></p>
        </div>

        <div id="actionButtons" class="hidden flex gap-3 action-row">
          <button id="downloadBtn" onclick="downloadSticker()" class="flex-1 py-2 bg-white border border-gray-200 rounded-lg">Download PNG</button>
          <button id="addToPackBtn" onclick="addToPack()" class="flex-1 py-2 btn-accent rounded-lg">âž• Add to Pack</button>
          <button id="shareBtn" onclick="shareSticker()" 
[cite_start]class="flex-1 py-2" style="background:linear-gradient(90deg,#34d399,#60a5fa); color:#fff; border-radius:12px;">Share</button> [cite: 52]
        </div>

        <div class="mt-4 space-y-2 text-xs muted">
          <div class="flex justify-between"><span>Pack items:</span><strong id="packCount">0</strong></div>
          <div class="flex gap-2">
            <button id="downloadPackBtn" onclick="downloadPack()" class="flex-1 py-2" style="background:linear-gradient(90deg,#7c3aed,#06b6d4);
[cite_start]color:#fff; border-radius:12px;">Download Pack (ZIP)</button> [cite: 53]
            <button onclick="clearPack()" class="py-2 px-3 bg-gray-100 rounded-lg">Clear</button>
          </div>
          <div class="text-xxs text-gray-500 mt-2">Tip: App runs locally if no server API key is configured.</div>
        </div>
      </div>

      <div class="lg:col-span-2 space-y-6">
        <div class="card p-4 preview-box rounded-glow">
   
        [cite_start]<div class="flex items-center justify-between mb-3 px-2"> [cite: 54]
            <h3 class="text-lg font-semibold">2 â€” Sticker Preview</h3>
            <div class="text-sm text-gray-500 muted">Canvas: 512Ã—512 (export)</div>
          </div>

          <div class="relative h-full flex items-center justify-center rounded-xl p-3" style="background: linear-gradient(180deg,#fef3c7,#eff6ff);
[cite_start]border:1px solid rgba(11,37,69,0.02);"> [cite: 55]
            <canvas id="stickerCanvas" width="512" height="512" class="shadow-inner"></canvas>
            <div id="initialPrompt" class="absolute text-center text-gray-600 pointer-events-none">
              <svg class="w-14 h-14 mx-auto mb-2 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          
          [cite_start]<p>Upload a photo and click **Generate Sticker**.</p> [cite: 56]
            </div>
          </div>
        </div>

        <div class="ad-unit h-44 rounded-xl flex items-center justify-center card">
          <div class="chip"><svg width="18" height="18" viewBox="0 0 24 24" fill="none"><path d="M12 4v16" stroke="#ffd166" stroke-width="2" stroke-linecap="round"/></svg><span class="muted">AD SENSE UNIT (336x280 / Native)</span></div>
    
        [cite_start]</div> [cite: 57]
      </div>
    </div>

    <div class="mt-8 grid lg:grid-cols-2 gap-4">
      <div class="card p-4 rounded-glow">
        <h3 class="text-lg font-semibold mb-2">About StickerGen AI â€” SEO-friendly writeup</h3>
        <p class="text-sm muted leading-relaxed">
          [cite_start]StickerGen AI converts your photos into high-quality, transparent PNG stickers ready for WhatsApp and Instagram. [cite: 58] [cite_start]Use the **AI Cartoon** mode for stylized cartoons, or use **Text** and **Emoji** modes to personalize stickers quickly. [cite: 59] [cite_start]The app emphasizes privacy â€” processing happens client-side when possible and images are not stored on our servers. [cite: 60] [cite_start]Export single stickers or build sticker packs (ZIP) for download. [cite: 61]
        </p>
        <p class="text-xs text-gray-500 mt-3">Tip: Use short text (<=20 chars) and high-contrast photos for best cartoon results.</p>
      </div>

      <div class="card p-4 rounded-glow">
        <h3 class="text-lg font-semibold mb-2">AD SENSE (Footer) â€” Good RPM spot</h3>
        <div class="bg-gradient-to-r from-white to-slate-50 p-3 rounded border border-gray-100 text-center">
          <strong class="text-gray-600">AD SENSE UNIT (Footer) â€” paste AdSense snippet here</strong>
        </div>
  
      [cite_start]</div> [cite: 62]
    </div>

    <footer class="mt-8 p-6 card rounded-glow">
      <div class="space-y-4">
        <h4 class="text-xl font-semibold">Privacy Policy & AdSense Compliance</h4>
        <p class="text-sm muted">Last Updated: Nov 29, 2025</p>

        <div class="text-sm text-gray-600 space-y-3">
          <strong>1.
[cite_start]Data handling & No-Storage</strong> [cite: 63]
          [cite_start]<p class="muted">StickerGen AI processes images client-side when possible. [cite: 64] [cite_start]Uploaded images are used only to generate stickers and are not stored persistently by this site. [cite: 65] If you configure a third-party AI server to process images (by adding an API key), images may be transmitted to that provider â€” ensure the provider's data policy meets your requirements before enabling server processing.</p>

          <strong>2.
[cite_start]Third-party services & ads</strong> [cite: 66]
          [cite_start]<p class="muted">We use Google AdSense to display ads. [cite: 67] [cite_start]Google, as a third-party vendor, may use cookies to serve ads based on the user's previous visits to our site and other sites. [cite: 68] [cite_start]To opt out of personalized ads, users may visit Google's Ads Settings. [cite: 69] We do not sell personal data.</p>

          <strong>3.
[cite_start]Third-party sharing</strong> [cite: 70]
          [cite_start]<p class="muted">Sharing uses native Web Share APIs and external apps; [cite: 71] we are not responsible for their data practices.</p>

          <strong>4.
[cite_start]Rights & requests</strong> [cite: 72]
          [cite_start]<p class="muted">If you wish to request deletion of stored data or exercise rights under GDPR/CCPA, contact the site owner at *privacy@example.com*. [cite: 73] Note: by default the site does not store images; the email is for any account or analytic requests.</p>
        </div>
      </div>
    </footer>
  </div>

  <div id="stickyAd" class="hidden fixed bottom-4 left-4 right-4 md:left-auto md:right-12 md:bottom-12 z-50">
    <div class="bg-white p-3 rounded-lg shadow-lg border border-gray-200 flex items-center justify-between">
      <div class="text-sm text-gray-600">AD SENSE ANCHOR (mobile sticky) â€” paste code here</div>
      <button onclick="document.getElementById('stickyAd').style.display='none'" class="text-xs px-2 py-1 rounded bg-gray-100">Close</button>
  
    [cite_start]</div> [cite: 74]
  </div>

  <div id="cookieConsent" class="cookie-consent hidden">
    [cite_start]<div class="flex-1 text-sm text-gray-800">We use cookies & third-party ads to improve experience and serve ads. [cite: 75] By continuing you accept our <a href="#privacyPolicy" class="underline">privacy policy</a>.</div>
    <div class="flex gap-2">
      <button onclick="acceptCookies()" class="px-3 py-1" style="background:linear-gradient(90deg,#06b6d4,#7c3aed); color:#fff; border-radius:8px;">Accept</button>
      <button onclick="declineCookies()" class="px-3 py-1 bg-gray-100 rounded">Decline</button>
    </div>
  </div>

  <script>
  /********** StickerGen AI â€” replacement main script (robust, fixed Generate) **********/
  [cite_start]const canvas = document.getElementById('stickerCanvas'); [cite: 76]
  const ctx = canvas.getContext('2d');
  const fileInput = document.getElementById('fileInput');
  const generateBtn = document.getElementById('generateBtn');
  const actionButtons = document.getElementById('actionButtons');
  [cite_start]const statusMessage = document.getElementById('statusMessage'); [cite: 77]
  const loadingSpinner = document.getElementById('loadingSpinner');
  const generateIcon = document.getElementById('generateIcon');
  const generateText = document.getElementById('generateText');
  const initialPrompt = document.getElementById('initialPrompt');
  [cite_start]const fileNameDisplay = document.getElementById('fileNameDisplay'); [cite: 78]
  const packCountEl = document.getElementById('packCount');

  const textInputGroup = document.getElementById('textInputGroup');
  const emojiInputGroup = document.getElementById('emojiInputGroup');
  const stickerText = document.getElementById('stickerText');
  [cite_start]const stickerEmoji = document.getElementById('stickerEmoji'); [cite: 79]
  const scaleRange = document.getElementById('scaleRange');
  const outlineToggle = document.getElementById('outlineToggle');
  const outlineThickness = document.getElementById('outlineThickness');
  const polishToggle = document.getElementById('polishToggle'); // FIXED: This now retrieves the element we added to the HTML

  [cite_start]let uploadedImageBase64 = null; [cite: 80]
  let originalImage = null;
  let pack = [];

  // API config (insert your key to enable server AI)
  [cite_start]const apiKey = ""; [cite: 81]
  // <-- Add Gemini API key to enable server-based generation
  const MODEL_NAME = "gemini-2.5-flash-image-preview";
  const API_URL = apiKey ?
  [cite_start]`https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${apiKey}` : null; [cite: 82]

  // ---------- utility & UI helpers ----------
  function showStatus(text, isError=false){
    statusMessage.textContent = text ||
[cite_start]""; [cite: 83]
    statusMessage.classList.toggle('text-red-600', !!isError);
    console.log("Status:", text);
  }
  function setProcessingState(isProcessing){
    generateBtn.disabled = isProcessing || !uploadedImageBase64;
    [cite_start]loadingSpinner.classList.toggle('hidden', !isProcessing); [cite: 84]
    generateIcon.classList.toggle('hidden', isProcessing);
    generateText.textContent = isProcessing ? 'Processing...' : 'Generate Sticker';
    if (isProcessing) showStatus('Processing image...');
  }
  [cite_start]function isSupportedImageType(type){ return /^image\/(png|jpeg|webp)$/i.test(type); [cite: 85]
  }

  // File -> base64
  function convertToBase64(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onerror = () => reject(new Error('File read error'));
      reader.onload = () => {
        const res = reader.result;
        const comma = res.indexOf(',');
        resolve({ data: res.slice(comma+1), mimeType: file.type || 'image/png' });
      };
      reader.readAsDataURL(file);
    
    [cite_start]}); [cite: 86]
  }

  // Fit calculations & drawing helpers (unchanged logic)
  function computeFitRect(imgW, imgH, canvasW, canvasH, scale=1){
    [cite_start]const ratio = Math.min((canvasW / imgW) * scale, (canvasH / imgH) * scale); [cite: 87]
    [cite_start]const dw = imgW * ratio, dh = imgH * ratio; [cite: 88]
    const dx = (canvasW - dw) / 2, dy = (canvasH - dh) / 2;
    [cite_start]return {dx,dy,dw,dh,ratio}; [cite: 89]
  }
  function drawCheckerboard(ctx, size=16){
    [cite_start]const w = ctx.canvas.width, h = ctx.canvas.height; [cite: 90]
    for (let y=0;y<h;y+=size) for (let x=0;x<w;x+=size){
      ctx.fillStyle = ((Math.floor(x/size)+Math.floor(y/size))%2===0) ? '#e6edf3' : '#ffffff';
      [cite_start]ctx.fillRect(x,y,size,size); [cite: 91]
    }
  }
  function roundRectStroke(ctx, x, y, w, h, r=12){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    [cite_start]ctx.closePath(); [cite: 92]
    ctx.stroke();
  }
  function drawPreview(img){
    if (!img) return;
    ctx.clearRect(0,0,canvas.width,canvas.height);
    drawCheckerboard(ctx);
    const scale = parseFloat(scaleRange?.value) || [cite_start]1; [cite: 93]
    const fit = computeFitRect(img.width, img.height, canvas.width, canvas.height, scale);
    [cite_start]ctx.drawImage(img, fit.dx, fit.dy, fit.dw, fit.dh); [cite: 94]
    if (outlineToggle && outlineToggle.checked){
      ctx.save();
      ctx.lineWidth = parseInt(outlineThickness.value || 12, 10);
      [cite_start]ctx.strokeStyle = 'white'; [cite: 95]
      roundRectStroke(ctx, fit.dx - ctx.lineWidth/2, fit.dy - ctx.lineWidth/2, fit.dw + ctx.lineWidth, fit.dh + ctx.lineWidth, 24);
      [cite_start]ctx.restore(); [cite: 96]
    }
  }

  // Overlay drawing
  function drawOverlay(type){
    [cite_start]if (!originalImage) { showStatus('No image to draw overlay on.', true); [cite: 97]
    return; }
    drawPreview(originalImage);
    ctx.textAlign = 'center';
    [cite_start]ctx.textBaseline = 'middle'; [cite: 98]
    if (type === 'text'){
      const t = (stickerText.value || '').trim();
      [cite_start]if (!t) return; [cite: 99]
      ctx.font = 'bold 60px Inter, sans-serif';
      ctx.lineWidth = 8; ctx.strokeStyle = 'black'; ctx.fillStyle = 'white';
      [cite_start]ctx.strokeText(t.toUpperCase(), canvas.width/2, canvas.height * 0.88); [cite: 100]
      ctx.fillText(t.toUpperCase(), canvas.width/2, canvas.height * 0.88);
    } else if (type === 'emoji'){
      [cite_start]const e = (stickerEmoji.value || '').trim(); [cite: 101]
      if (!e) return;
      ctx.font = '110px Inter, sans-serif';
      [cite_start]ctx.fillText(e, canvas.width * 0.82, canvas.height * 0.16); [cite: 102]
    }
  }

  // ---------- local cartoonify fallback (unchanged) ----------
  function posterizeCanvasFromImage(img, levels = 6){
    [cite_start]const tmp = document.createElement('canvas'); [cite: 103]
    tmp.width = 512; tmp.height = 512;
    const tctx = tmp.getContext('2d'); tctx.drawImage(img, 0,0,tmp.width,tmp.height);
    [cite_start]const id = tctx.getImageData(0,0,tmp.width,tmp.height); [cite: 104]
    for (let i=0;i<id.data.length;i+=4) for (let c=0;c<3;c++){
      [cite_start]const v = id.data[i+c]; [cite: 105]
      const q = Math.floor((v/255)*(levels-1)) * (255/(levels-1)); id.data[i+c] = q;
    }
    [cite_start]tctx.putImageData(id,0,0); return tmp; [cite: 106]
  }
  function edgeDetectCanvas(srcCanvas){
    const w = srcCanvas.width, h = srcCanvas.height;
    [cite_start]const sctx = srcCanvas.getContext('2d'); [cite: 107]
    const src = sctx.getImageData(0,0,w,h);
    const out = sctx.createImageData(w,h);
    for (let y=1;y<h-1;y++) for (let x=1;x<w-1;x++){
      [cite_start]let sum=0; [cite: 108]
      for (let ky=-1;ky<=1;ky++) for (let kx=-1;kx<=1;kx++){
        [cite_start]const idx = ((y+ky)*w + (x+kx))*4; [cite: 109]
        const gray = (src.data[idx]+src.data[idx+1]+src.data[idx+2])/3;
        [cite_start]sum += gray * ((kx===0 && ky===0) ? -8 : 1); [cite: 110]
      }
      const oidx = (y*w + x)*4; const val = Math.max(0, Math.min(255, Math.abs(sum)));
      [cite_start]out.data[oidx] = out.data[oidx+1] = out.data[oidx+2] = 255 - val; out.data[oidx+3] = 255; [cite: 111]
    }
    [cite_start]const eCanvas = document.createElement('canvas'); [cite: 112]
    eCanvas.width=w; eCanvas.height=h; eCanvas.getContext('2d').putImageData(out,0,0); return eCanvas;
  }
  async function inBrowserCartoonify(img){
    [cite_start]showStatus('Running local cartoonify...'); [cite: 113]
    const poster = posterizeCanvasFromImage(img, 6);
    const edges = edgeDetectCanvas(poster);
    [cite_start]const out = document.createElement('canvas'); out.width = 512; out.height = 512; [cite: 114]
    const octx = out.getContext('2d'); octx.drawImage(poster,0,0,out.width,out.height);
    octx.globalCompositeOperation = 'multiply'; octx.drawImage(edges,0,0,out.width,out.height); octx.globalCompositeOperation = 'source-over';
    const id = octx.getImageData(0,0,out.width,out.height);
    [cite_start]function sample(x,y){ const idx=(y*out.width+x)*4; [cite: 115]
    return [id.data[idx],id.data[idx+1],id.data[idx+2]]; }
    const c1=sample(2,2), c2=sample(out.width-3,2), c3=sample(2,out.height-3), c4=sample(out.width-3,out.height-3);
    [cite_start]const bg = [(c1[0]+c2[0]+c3[0]+c4[0])/4, (c1[1]+c2[1]+c3[1]+c4[1])/4, (c1[2]+c2[2]+c3[2]+c4[2])/4]; [cite: 116]
    for (let i=0;i<id.data.length;i+=4){ const dr=id.data[i]-bg[0], dg=id.data[i+1]-bg[1], db=id.data[i+2]-bg[2]; const dist=Math.sqrt(dr*dr+dg*dg+db*db); if (dist<90) id.data[i+3]=0; }
    [cite_start]octx.putImageData(id,0,0); return out; [cite: 117]
  }

  // ---------- network helper ----------
  async function fetchWithExponentialBackoff(url, options, maxRetries=4){
    for (let i=0;i<maxRetries;i++){
      try {
        [cite_start]const r = await fetch(url, options); [cite: 118]
        if (r.status === 429) {
          [cite_start]await new Promise(res => setTimeout(res, Math.pow(2, i) * 1000)); [cite: 119]
          continue;
        }
        [cite_start]return r; [cite: 120]
      } catch (e){
        [cite_start]console.warn('Fetch attempt failed', e); [cite: 121]
        await new Promise(res => setTimeout(res, Math.pow(2, i) * 500));
      }
    }
    [cite_start]throw new Error('Network error after retries'); [cite: 122]
  }

  // ---------- post-process functions (graceful no-op if not provided) ----------
  async function postProcessCurrentImage(opts = {}) {
    if (typeof window.postProcessCurrentImage === 'function') {
      try {
        [cite_start]await window.postProcessCurrentImage(opts); [cite: 123]
        return;
      } catch (err) {
        [cite_start]console.warn('postProcessCurrentImage failed fallback:', err); [cite: 124]
      }
    }
    return;
  }

  // ---------- core flow: prepare & generate ----------
  async function prepareAndGenerate(){
    try {
      [cite_start]setProcessingState(true); [cite: 125]
      const selectedType = document.querySelector('input[name="stickerType"]:checked')?.value;
      actionButtons.classList.add('hidden');

      if (!uploadedImageBase64 || !fileInput.files || !fileInput.files[0]) {
        [cite_start]showStatus('Please upload an image first.', true); [cite: 126]
        setProcessingState(false);
        return;
      }

      if (!selectedType) {
        [cite_start]showStatus('Select a sticker type first.', true); [cite: 127]
        setProcessingState(false);
        return;
      }

      if (selectedType === 'text' || selectedType === 'emoji') {
        const content = selectedType === 'text' ?
        [cite_start]stickerText.value.trim() : stickerEmoji.value.trim(); [cite: 128]
        if (!content) {
          [cite_start]showStatus(`Please enter the ${selectedType} before generating.`, true); [cite: 129]
          setProcessingState(false);
          return;
        }

        [cite_start]drawOverlay(selectedType); [cite: 130]
        if (polishToggle && polishToggle.checked) {
          [cite_start]const tmpImg = new Image(); [cite: 131]
          tmpImg.src = canvas.toDataURL('image/png');
          await new Promise((res,rej) => { tmpImg.onload = res; tmpImg.onerror = rej; });
          [cite_start]originalImage = tmpImg; [cite: 132]
          await postProcessCurrentImage({feather:6, outlineWidth:10, shadowBlur:14, shadowAlpha:0.2});
          drawPreview(originalImage);
        }

        actionButtons.classList.remove('hidden');
        showStatus('Sticker generated!');
        setProcessingState(false);
        [cite_start]return; [cite: 133]
      }

      if (selectedType === 'cartoon') {
        [cite_start]await generateAISticker(); [cite: 134]
        setProcessingState(false);
        return;
      }

      showStatus('Unknown sticker type selected.', true);
      [cite_start]setProcessingState(false); [cite: 135]
    } catch (err) {
      console.error('prepareAndGenerate error:', err);
      showStatus('Unexpected error. See console for details.', true);
      [cite_start]setProcessingState(false); [cite: 136]
    }
  }

  async function generateAISticker(){
    try {
      [cite_start]setProcessingState(true); [cite: 137]
      if (!originalImage) {
        [cite_start]showStatus('No image loaded to convert. Please upload a photo first.', true); [cite: 138]
        setProcessingState(false);
        return;
      }

      if (!API_URL) {
        [cite_start]showStatus('No API key found â€” using local cartoonify fallback.'); [cite: 139]
        try {
          [cite_start]const fallbackCanvas = await inBrowserCartoonify(originalImage); [cite: 140]
          const img = new Image();
          img.src = fallbackCanvas.toDataURL('image/png');
          [cite_start]await new Promise((res, rej) => { img.onload = res; img.onerror = rej; }); [cite: 141]
          originalImage = img;

          if (polishToggle && polishToggle.checked) {
            [cite_start]await postProcessCurrentImage({feather:6, outlineWidth:10, shadowBlur:16, shadowAlpha:0.22}); [cite: 142]
          }

          drawPreview(originalImage);
          actionButtons.classList.remove('hidden');
          showStatus('âœ¨ Cartoon sticker ready (local).');
          [cite_start]return; [cite: 143]
        } catch (err) {
          [cite_start]console.error('Local cartoonify failed:', err); [cite: 144]
          showStatus('Local cartoonify failed. See console for details.', true);
          return;
        } finally {
          [cite_start]setProcessingState(false); [cite: 145]
        }
      }

      [cite_start]showStatus('Sending the image to AI server (if configured)...'); [cite: 146]
      [cite_start]const prompt = "Convert subject into vibrant cartoon sticker. Remove background. Output transparent PNG 512x512."; [cite: 147]
      const payload = {
        contents: [{
          parts: [
            { text: prompt },
            { inlineData: { mimeType: fileInput.dataset.mimeType ||
[cite_start]'image/png', data: uploadedImageBase64 } } [cite: 148]
          ]
        }],
        generationConfig: { responseModalities: ['IMAGE'] }
      [cite_start]}; [cite: 149]
      try {
        const res = await fetchWithExponentialBackoff(API_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        [cite_start]}, 4); [cite: 150]
        if (!res.ok) {
          [cite_start]const txt = await res.text().catch(()=>null); [cite: 151]
          console.warn('AI server response not OK', res.status, txt);
          [cite_start]showStatus('AI server returned an error â€” using local fallback.', true); [cite: 152]
          const fallbackCanvas = await inBrowserCartoonify(originalImage);
          [cite_start]const img = new Image(); img.src = fallbackCanvas.toDataURL('image/png'); await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; }); [cite: 153]
          originalImage = img;
          if (polishToggle && polishToggle.checked) await postProcessCurrentImage({feather:6, outlineWidth:10, shadowBlur:16, shadowAlpha:0.22});
          drawPreview(originalImage);
          actionButtons.classList.remove('hidden');
          [cite_start]return; [cite: 154]
        }

        const json = await res.json();
        [cite_start]const base64Data = json?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data; [cite: 155]
        if (!base64Data) {
          [cite_start]console.warn('AI returned no image data', json); [cite: 156]
          showStatus('AI did not return an image. Running local fallback.', true);
          const fallbackCanvas = await inBrowserCartoonify(originalImage);
          [cite_start]const img = new Image(); [cite: 157]
          img.src = fallbackCanvas.toDataURL('image/png'); await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; });
          [cite_start]originalImage = img; [cite: 158]
          if (polishToggle && polishToggle.checked) await postProcessCurrentImage({feather:6, outlineWidth:10, shadowBlur:16, shadowAlpha:0.22});
          drawPreview(originalImage);
          actionButtons.classList.remove('hidden');
          [cite_start]return; [cite: 159]
        }

        const imageUrl = `data:image/png;base64,${base64Data}`;
        const aiImg = new Image();
        [cite_start]aiImg.src = imageUrl; [cite: 160]
        await new Promise((res,rej)=>{ aiImg.onload=res; aiImg.onerror=rej; });

        originalImage = aiImg;
        if (polishToggle && polishToggle.checked) {
          [cite_start]await postProcessCurrentImage({feather:6, outlineWidth:10, shadowBlur:16, shadowAlpha:0.22}); [cite: 161]
        }
        drawPreview(originalImage);
        actionButtons.classList.remove('hidden');
        [cite_start]showStatus('âœ¨ Cartoon sticker ready!'); [cite: 162]
      } catch (err) {
        [cite_start]console.error('generateAISticker error:', err); [cite: 163]
        showStatus('AI call failed â€” running local fallback.', true);
        try {
          [cite_start]const fallbackCanvas = await inBrowserCartoonify(originalImage); [cite: 164]
          const img = new Image(); img.src = fallbackCanvas.toDataURL('image/png'); await new Promise((res,rej)=>{ img.onload=res; img.onerror=rej; });
          [cite_start]originalImage = img; [cite: 165]
          if (polishToggle && polishToggle.checked) await postProcessCurrentImage({feather:6, outlineWidth:10, shadowBlur:16, shadowAlpha:0.22});
          drawPreview(originalImage);
          [cite_start]actionButtons.classList.remove('hidden'); [cite: 166]
        } catch (fbErr) {
          [cite_start]console.error('fallback after AI failed:', fbErr); [cite: 167]
          showStatus('All generation attempts failed. See console for details.', true);
        }
      } finally {
        [cite_start]setProcessingState(false); [cite: 168]
      }

    } catch (err) {
      [cite_start]console.error('generateAISticker outer error:', err); [cite: 169]
      showStatus('Unexpected error during generation. See console.', true);
      setProcessingState(false);
    }
  }

  // ---------- export & sharing (unchanged logic) ----------
  function buildExportCanvas(){
    [cite_start]const tmp = document.createElement('canvas'); [cite: 170]
    tmp.width=512; tmp.height=512; const tctx = tmp.getContext('2d'); tctx.clearRect(0,0,tmp.width,tmp.height);
    [cite_start]if (originalImage) { const fit = computeFitRect(originalImage.width, originalImage.height, tmp.width, tmp.height, parseFloat(scaleRange.value)||1); [cite: 171]
    tctx.drawImage(originalImage, fit.dx, fit.dy, fit.dw, fit.dh); }
    [cite_start]const selectedType = document.querySelector('input[name="stickerType"]:checked')?.value; [cite: 172]
    [cite_start]if (selectedType === 'text' && stickerText.value.trim()) { tctx.font='bold 60px Inter, sans-serif'; tctx.textAlign='center'; tctx.fillStyle='white'; tctx.strokeStyle='black'; tctx.lineWidth=8; tctx.strokeText(stickerText.value.toUpperCase(), tmp.width/2, tmp.height*0.88); [cite: 173]
    tctx.fillText(stickerText.value.toUpperCase(), tmp.width/2, tmp.height*0.88); }
    [cite_start]else if (selectedType === 'emoji' && stickerEmoji.value.trim()) { tctx.font='110px Inter, sans-serif'; [cite: 174]
    tctx.fillText(stickerEmoji.value.trim(), tmp.width * 0.82, tmp.height * 0.16); }
    [cite_start]return tmp; [cite: 175]
  }
  function downloadSticker(){
    [cite_start]const out = buildExportCanvas(); [cite: 176]
    [cite_start]out.toBlob(blob=>{ const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='ai-sticker.png'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url); showStatus('Download complete!'); }, 'image/png'); [cite: 177]
  }
  async function shareSticker(){
    try {
      [cite_start]const out = buildExportCanvas(); [cite: 178]
      const blob = await new Promise(res=>out.toBlob(res, 'image/png'));
      [cite_start]const file = new File([blob], 'ai-sticker.png', { type: 'image/png' }); [cite: 179]
      [cite_start]if (navigator.canShare && navigator.canShare({ files: [file] })) { await navigator.share({ files: [file], title:'StickerGen AI', text:'Check my sticker!' }); showStatus('Shared successfully!'); [cite: 180]
      }
      [cite_start]else { showStatus('Sharing not supported â€” downloading.'); downloadSticker(); [cite: 181]
      }
    [cite_start]} catch (err) { console.error('shareSticker error', err); showStatus('Share failed â€” downloading.', true); downloadSticker(); [cite: 182]
    }
  }
  async function addToPack(){
    [cite_start]const out = buildExportCanvas(); const blob = await new Promise(res=>out.toBlob(res,'image/png')); [cite: 183]
    pack.push(blob); packCountEl.textContent = pack.length; showStatus('Added to pack.');
  }
  [cite_start]function clearPack(){ pack = []; packCountEl.textContent = 0; showStatus('Pack cleared.'); [cite: 184]
  }
  async function downloadPack(){
    if (!pack.length){ showStatus('Pack empty.', true); return; }
    [cite_start]showStatus('Preparing pack...'); [cite: 185]
    const zip = new JSZip();
    pack.forEach((b,i)=> zip.file(`sticker_${i+1}.png`, b));
    const content = await zip.generateAsync({ type:'blob' });
    [cite_start]const url = URL.createObjectURL(content); [cite: 186]
    const a = document.createElement('a'); a.href = url; a.download = 'sticker-pack.zip'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    [cite_start]showStatus('Pack downloaded!'); [cite: 187]
  }

  // ---------- file input handling ----------
  fileInput.addEventListener('change', async (e) => {
    try {
      const file = e.target.files?.[0];
      if (!file) {
        fileNameDisplay.textContent = 'No file selected.';
        uploadedImageBase64 = null;
        generateBtn.disabled = true;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        initialPrompt.classList.remove('hidden');
        return;
      }
   
      [cite_start]if (!isSupportedImageType(file.type)) { [cite: 188]
        fileNameDisplay.textContent = 'Error: Only PNG, JPG, WebP supported.';
        uploadedImageBase64 = null;
        generateBtn.disabled = true;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        initialPrompt.classList.remove('hidden');
        showStatus('Unsupported image type.', true);
        return;
      }

      fileNameDisplay.textContent = `File loaded: ${file.name}`;
      const { data, 
[cite_start]mimeType } = await convertToBase64(file); [cite: 189]
      uploadedImageBase64 = data;
      fileInput.dataset.mimeType = mimeType;

      [cite_start]const obj = URL.createObjectURL(file); [cite: 190]
      const img = new Image();
      img.onload = ()=>{
        originalImage = img;
        drawPreview(img);
        [cite_start]URL.revokeObjectURL(obj); [cite: 191]
        generateBtn.disabled = false;
        actionButtons.classList.add('hidden');
        initialPrompt.classList.add('hidden');
        showStatus('Ready to generate!');
      };
      [cite_start]img.onerror = (err) => { console.error('Image load error', err); [cite: 192]
      showStatus('Error loading image.', true); URL.revokeObjectURL(obj); };
      img.src = obj;
    } catch (err) {
      [cite_start]console.error('file input handler error', err); [cite: 193]
      showStatus('Failed to read file.', true);
    }
  });

  // ---------- controls ----------
  function updateControls(){
    [cite_start]const selectedType = document.querySelector('input[name="stickerType"]:checked')?.value; [cite: 194]
    textInputGroup.classList.toggle('hidden', selectedType !== 'text');
    emojiInputGroup.classList.toggle('hidden', selectedType !== 'emoji');
    if (originalImage){ drawPreview(originalImage); actionButtons.classList.add('hidden'); }
  }
  [cite_start]updateControls(); generateBtn.disabled = true; [cite: 195]
  // cookie handlers & window exposure
  function acceptCookies(){ document.getElementById('cookieConsent').classList.add('hidden'); }
  function declineCookies(){ document.getElementById('cookieConsent').classList.add('hidden'); }
  [cite_start]window.acceptCookies = acceptCookies; [cite: 196]
  window.declineCookies = declineCookies;

  window.prepareAndGenerate = prepareAndGenerate;
  window.downloadSticker = downloadSticker;
  window.shareSticker = shareSticker;
  window.addToPack = addToPack;
  [cite_start]window.clearPack = clearPack; [cite: 197]
  window.downloadPack = downloadPack;
  window.updateControls = updateControls;

  // show sticky ad and cookie bar as before
  [cite_start]setTimeout(()=>{ const el=document.getElementById('stickyAd'); if (el) el.classList.remove('hidden'); }, 2500); [cite: 198]
  setTimeout(()=>{ const c=document.getElementById('cookieConsent'); if (c) c.classList.remove('hidden'); }, 1000);
  </script>
</body>
</html>
