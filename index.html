<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  
  <!-- SEO & Meta Tags -->
  <title>CropXPro ‚Äî AI Auto-Crop for Reels, TikTok & Shorts</title>
  <meta name="description" content="Free AI Video Cropper. Auto-crop horizontal videos to vertical (9:16) for Instagram Reels, TikTok, and YouTube Shorts. Features Face Detection, Batch Processing, and Privacy-Focused Client-Side rendering." />
  <meta name="keywords" content="video cropper, ai video resize, reels maker, tiktok converter, face detection crop, ffmpeg wasm, free video editor, 9:16 converter" />
  
  <!-- Social Media Cards -->
  <meta property="og:title" content="CropXPro ‚Äî AI Video Cropper" />
  <meta property="og:description" content="Turn horizontal videos into viral vertical reels instantly with AI face detection." />
  <meta property="og:type" content="website" />
  <meta name="twitter:card" content="summary_large_image" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=Outfit:wght@500;700;800&display=swap" rel="stylesheet">

  <style>
    /* --- CSS Variables & Reset --- */
    :root {
      --primary: #6366f1;
      --primary-dark: #4f46e5;
      --secondary: #ec4899;
      --accent: #8b5cf6;
      --bg-dark: #0f172a;
      --surface: #1e293b;
      --surface-light: #334155;
      --text: #f8fafc;
      --text-muted: #94a3b8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --radius: 16px;
      --shadow: 0 10px 30px -10px rgba(0,0,0,0.5);
    }

    * { box-sizing: border-box; outline: none; }
    
    body {
      margin: 0;
      background-color: var(--bg-dark);
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 85% 30%, rgba(236, 72, 153, 0.15) 0%, transparent 50%);
      color: var(--text);
      font-family: 'Inter', sans-serif;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
    }

    h1, h2, h3, h4 { font-family: 'Outfit', sans-serif; margin: 0; }
    
    /* --- Layout Components --- */
    header {
      width: 100%;
      max-width: 1200px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      margin-bottom: 30px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .brand-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 20px rgba(99, 102, 241, 0.4);
    }

    .brand-text h1 {
      font-size: 24px;
      background: linear-gradient(to right, #fff, #cbd5e1);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .brand-text span {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
      letter-spacing: 0.5px;
    }

    .nav-links button {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 14px;
      transition: color 0.2s;
    }
    .nav-links button:hover { color: #fff; }

    main {
      width: 100%;
      max-width: 1200px;
      display: grid;
      grid-template-columns: 1fr 340px;
      gap: 24px;
    }

    @media(max-width: 900px) {
      main { grid-template-columns: 1fr; }
    }

    /* --- Cards & Panels --- */
    .card {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 24px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 16px;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }

    .card-title {
      font-size: 18px;
      font-weight: 600;
    }

    /* --- Buttons & Inputs --- */
    .btn {
      background: linear-gradient(135deg, var(--primary), var(--primary-dark));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .btn:hover { transform: translateY(-1px); box-shadow: 0 6px 16px rgba(99, 102, 241, 0.4); }
    .btn:active { transform: translateY(0); }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }

    .btn.secondary {
      background: var(--surface-light);
      box-shadow: none;
      color: var(--text);
    }
    .btn.secondary:hover { background: #475569; }

    .file-drop-area {
      border: 2px dashed rgba(255,255,255,0.15);
      border-radius: var(--radius);
      padding: 30px;
      text-align: center;
      transition: all 0.2s;
      background: rgba(255,255,255,0.02);
      cursor: pointer;
    }
    .file-drop-area:hover { border-color: var(--primary); background: rgba(99, 102, 241, 0.05); }

    /* --- File List --- */
    .video-item {
      display: flex;
      gap: 12px;
      padding: 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 12px;
      margin-bottom: 8px;
      align-items: center;
      border: 1px solid rgba(255,255,255,0.05);
    }

    .video-thumb {
      width: 80px;
      height: 45px;
      background: #000;
      border-radius: 6px;
      object-fit: cover;
    }

    .video-info { flex: 1; min-width: 0; }
    .video-name { font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 14px; }
    .video-meta { font-size: 12px; color: var(--text-muted); }

    /* --- Options & Toggles --- */
    .options-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
      margin-top: 10px;
    }

    .checkbox-card {
      background: var(--surface-light);
      padding: 10px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      border: 1px solid transparent;
      transition: all 0.2s;
      font-size: 13px;
    }
    .checkbox-card:hover { background: #475569; }
    .checkbox-card input:checked + span { color: var(--primary); font-weight: 600; }
    .checkbox-card.active { border-color: var(--primary); background: rgba(99, 102, 241, 0.1); }

    /* --- Previews --- */
    .preview-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }
    .preview-card {
      background: #000;
      border-radius: 10px;
      overflow: hidden;
      position: relative;
    }
    .preview-card video { width: 100%; height: auto; display: block; aspect-ratio: 9/16; object-fit: cover; }
    .preview-actions {
      padding: 8px;
      background: var(--surface);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    /* --- Progress & Status --- */
    .progress-container { margin-top: 16px; }
    .progress-bar {
      height: 6px;
      background: var(--surface-light);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 6px;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--primary), var(--secondary));
      width: 0%;
      transition: width 0.3s;
    }
    .log-area {
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 11px;
      color: var(--text-muted);
      max-height: 100px;
      overflow-y: auto;
      background: rgba(0,0,0,0.3);
      padding: 8px;
      border-radius: 8px;
      margin-top: 12px;
    }

    /* --- AdSense Slots --- */
    .ad-slot {
      width: 100%;
      min-height: 100px;
      background: rgba(255,255,255,0.03);
      border: 1px dashed rgba(255,255,255,0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      font-size: 12px;
      margin: 20px 0;
      overflow: hidden;
    }

    /* --- SEO & Footer --- */
    .seo-content {
      max-width: 900px;
      margin: 40px auto;
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.6;
    }
    .seo-content h2 { color: var(--text); font-size: 20px; margin-top: 24px; margin-bottom: 12px; }

    footer {
      border-top: 1px solid rgba(255,255,255,0.05);
      width: 100%;
      padding: 30px 0;
      text-align: center;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* --- Modal --- */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8);
      backdrop-filter: blur(5px);
      z-index: 1000;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    .modal.open { display: flex; }
    .modal-content {
      background: var(--surface);
      width: 100%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
      border-radius: 20px;
      padding: 30px;
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--text);
    }
    .close-modal { float: right; cursor: pointer; font-size: 24px; color: var(--text-muted); }
    .close-modal:hover { color: white; }

    /* Utility */
    .badge { padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 700; text-transform: uppercase; }
    .badge-pro { background: linear-gradient(90deg, #f59e0b, #d97706); color: black; }
  </style>
</head>
<body>

  <!-- Privacy Policy Modal -->
  <div id="privacyModal" class="modal">
    <div class="modal-content">
      <span class="close-modal">&times;</span>
      <h2>Privacy Policy</h2>
      <p><small>Last Updated: November 2025</small></p>
      
      <h4>1. Data Processing & Storage (No Saving)</h4>
      <p>CropXPro is a strictly <strong>client-side application</strong>. All video processing is performed locally within your web browser using WebAssembly technology. 
      <br><strong>We do not save, store, or upload your videos to any server.</strong> Once you close the tab or refresh the page, all data is permanently lost from the application memory.</p>

      <h4>2. Cookies & Advertising (AdSense)</h4>
      <p>We use third-party vendors, including Google, to serve ads based on a user's prior visits to this website or other websites.</p>
      <ul>
        <li>Google's use of advertising cookies enables it and its partners to serve ads to your users based on their visit to your sites and/or other sites on the Internet.</li>
        <li>Users may opt out of personalized advertising by visiting <a href="https://www.google.com/settings/ads" target="_blank" style="color:var(--primary)">Google Ad Settings</a>.</li>
      </ul>

      <h4>3. Face Detection Privacy</h4>
      <p>Face detection is performed locally using the `face-api.js` library. No biometric data is sent to the cloud. The data is used solely for the purpose of calculating crop coordinates and is discarded immediately after processing.</p>
    </div>
  </div>

  <header>
    <div class="brand">
      <div class="brand-icon">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>
      </div>
      <div class="brand-text">
        <h1>CropXPro</h1>
        <span>AI Auto-Crop Studio</span>
      </div>
    </div>
    <div class="nav-links">
      <button id="openPrivacy">Privacy Policy</button>
    </div>
  </header>

  <!-- AdSlot: Top Banner -->
  <div class="ad-slot" style="max-width:1200px; margin-bottom: 20px;">
    <!-- PASTE TOP BANNER ADSENSE CODE HERE -->
    <span style="opacity:0.5">Advertisement Space</span>
  </div>

  <main>
    <!-- LEFT COLUMN: Controls -->
    <div class="col-left">
      <div class="card">
        <div class="card-header">
          <div class="card-title">1. Upload Videos</div>
          <span class="badge badge-pro">Free</span>
        </div>
        
        <div class="file-drop-area" id="dropArea">
          <div style="font-size:32px; margin-bottom:10px;">‚òÅÔ∏è</div>
          <h3 style="margin-bottom:6px">Click or Drop Videos Here</h3>
          <div style="font-size:13px; color:var(--text-muted)">MP4, MOV supported. Max 10 mins recommended.</div>
          <input type="file" id="fileInput" multiple accept="video/*" style="display:none">
        </div>

        <div id="fileList" style="margin-top:16px;"></div>
      </div>

      <div class="card">
        <div class="card-header">
          <div class="card-title">2. Output Settings</div>
        </div>

        <label style="font-size:13px; font-weight:600; color:var(--text-muted)">TARGET ASPECT RATIOS</label>
        <div class="options-grid">
          <label class="checkbox-card active">
            <input type="checkbox" class="aspect-opt" value="9:16" checked> 
            <span>9:16 (Reels/TikTok)</span>
          </label>
          <label class="checkbox-card active">
            <input type="checkbox" class="aspect-opt" value="1:1" checked> 
            <span>1:1 (Square Feed)</span>
          </label>
          <label class="checkbox-card">
            <input type="checkbox" class="aspect-opt" value="4:5"> 
            <span>4:5 (Portrait)</span>
          </label>
        </div>

        <div style="margin-top:20px;">
          <label style="font-size:13px; font-weight:600; color:var(--text-muted)">AI & PERFORMANCE</label>
          <div class="options-grid">
             <label class="checkbox-card" title="Keeps subject in center">
              <input type="checkbox" id="optZoom"> 
              <span>üîç Dynamic Zoom</span>
            </label>
            <label class="checkbox-card" title="Reduces resolution slightly to prevent crashes on long videos">
              <input type="checkbox" id="optSafeMode" checked> 
              <span>üõ°Ô∏è Safe Mode (10min+)</span>
            </label>
          </div>
        </div>

        <button id="processBtn" class="btn" style="width:100%; margin-top:24px; justify-content:center;" disabled>
          <span>‚ú® Start Auto-Crop Processing</span>
        </button>

        <div class="progress-container" id="progressArea" style="display:none">
          <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
          <div style="display:flex; justify-content:space-between; font-size:12px;">
            <span id="progressText">Initializing AI...</span>
            <span id="progressPercent">0%</span>
          </div>
          <div class="log-area" id="logArea"></div>
        </div>
      </div>
      
      <!-- AdSlot: In-Feed -->
      <div class="ad-slot">
        <!-- PASTE IN-FEED ADSENSE CODE HERE -->
        <span style="opacity:0.5">Advertisement Space</span>
      </div>
    </div>

    <!-- RIGHT COLUMN: Results -->
    <aside class="col-right">
      <div class="card" style="position:sticky; top:20px; height:auto; max-height: calc(100vh - 40px); display:flex; flex-direction:column;">
        <div class="card-header">
          <div class="card-title">3. Results</div>
          <button id="downloadAllBtn" class="btn secondary" style="padding:6px 12px; font-size:12px;" disabled>Download All</button>
        </div>
        
        <div id="resultsArea" style="flex:1; overflow-y:auto; min-height:200px;">
          <div style="text-align:center; padding:40px 0; color:var(--text-muted); opacity:0.6;">
            <div style="font-size:40px; margin-bottom:10px;">üé¨</div>
            Processed clips will appear here
          </div>
        </div>
      </div>
      
      <!-- AdSlot: Sidebar -->
      <div class="ad-slot" style="height: 300px; display:flex; margin-top: 20px;">
         <!-- PASTE SIDEBAR ADSENSE CODE HERE -->
         <span style="opacity:0.5">Advertisement Space</span>
      </div>
    </aside>
  </main>

  <!-- SEO Content Section -->
  <section class="seo-content">
    <h2>Why use CropXPro?</h2>
    <p>CropXPro is the ultimate free tool to <strong>convert horizontal videos to vertical</strong> for social media. Whether you are a content creator repurposing YouTube videos for TikTok, Instagram Reels, or YouTube Shorts, our tool uses advanced AI to detect faces and keep the action centered.</p>
    
    <h3>Key Features</h3>
    <ul>
      <li><strong>AI Face Tracking:</strong> Automatically detects faces to ensure your subject is never cut out of the frame.</li>
      <li><strong>Batch Processing:</strong> Upload multiple clips and convert them to 9:16, 1:1, and 4:5 ratios simultaneously.</li>
      <li><strong>100% Privacy:</strong> Unlike other online converters, CropXPro runs entirely in your browser using FFmpeg WASM. Your files never leave your device.</li>
      <li><strong>Long Video Support:</strong> Process videos up to 10 minutes in length with our optimized Safe Mode.</li>
    </ul>
    
    <p>Perfect for podcasters, streamers, and marketers looking to create viral clips from long-form content instantly.</p>
  </section>

  <footer>
    <div>¬© 2024 CropXPro. All rights reserved.</div>
    <div style="margin-top:8px; font-size:11px; opacity:0.6;">
      <strong>Note:</strong> We do not store your data. All processing is destroyed when you leave this page.
      <br>This site is not affiliated with Instagram, TikTok or YouTube.
    </div>
  </footer>

  <!-- Scripts: Corrected CDN and loading order -->
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.12.10/dist/umd/ffmpeg.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/util@0.12.1/dist/umd/index.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      // --- Variables ---
      let FFmpeg = null;
      let fetchFile = null;
      let toBlobURL = null;
      let ffmpeg = null;
      
      const files = [];
      const dropArea = document.getElementById('dropArea');
      const fileInput = document.getElementById('fileInput');
      const fileList = document.getElementById('fileList');
      const processBtn = document.getElementById('processBtn');
      const resultsArea = document.getElementById('resultsArea');
      const logEl = document.getElementById('logArea');
      const progressBar = document.getElementById('progressBar');
      const progressText = document.getElementById('progressText');
      const progressArea = document.getElementById('progressArea');
      const downloadAllBtn = document.getElementById('downloadAllBtn');

      // --- UI Interactions ---
      
      // Privacy Modal
      const modal = document.getElementById('privacyModal');
      document.getElementById('openPrivacy').onclick = () => modal.classList.add('open');
      document.querySelector('.close-modal').onclick = () => modal.classList.remove('open');
      window.onclick = (e) => { if(e.target == modal) modal.classList.remove('open'); };

      // File Handling
      dropArea.addEventListener('click', () => fileInput.click());
      
      ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropArea.addEventListener(eventName, preventDefaults, false);
      });
      function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
      
      dropArea.addEventListener('drop', (e) => handleFiles(e.dataTransfer.files));
      fileInput.addEventListener('change', (e) => handleFiles(e.target.files));

      function handleFiles(fileListItems) {
        if (!fileListItems.length) return;
        
        // Remove empty state placeholder
        if(files.length === 0) fileList.innerHTML = '';

        Array.from(fileListItems).forEach(file => {
          if(!file.type.startsWith('video/')) return;
          
          const id = Math.random().toString(36).substr(2, 9);
          const fileObj = { file, id, name: file.name };
          files.push(fileObj);
          
          renderFileRow(fileObj);
        });
        
        updateProcessBtn();
      }

      function renderFileRow(item) {
        const div = document.createElement('div');
        div.className = 'video-item';
        div.id = `row-${item.id}`;
        
        // Generate thumbnail
        const video = document.createElement('video');
        video.preload = 'metadata';
        video.src = URL.createObjectURL(item.file);
        video.onloadedmetadata = () => {
           video.currentTime = 1; 
           const duration = Math.round(video.duration);
           div.querySelector('.meta-dur').textContent = `${Math.floor(duration/60)}:${(duration%60).toString().padStart(2,'0')}`;
           if(duration > 600) div.querySelector('.meta-dur').innerHTML += ' <span style="color:var(--warning)">‚ö†Ô∏è Long</span>';
        };

        div.innerHTML = `
          <video class="video-thumb" src="${video.src}" muted></video>
          <div class="video-info">
            <div class="video-name" title="${item.name}">${item.name}</div>
            <div class="video-meta">
              <span>${(item.file.size/1024/1024).toFixed(1)} MB</span> ‚Ä¢ 
              <span class="meta-dur">...</span>
            </div>
          </div>
          <button class="btn secondary" style="padding:6px;" onclick="removeFile('${item.id}')">‚úï</button>
        `;
        fileList.appendChild(div);
      }

      window.removeFile = (id) => {
        const idx = files.findIndex(f => f.id === id);
        if(idx > -1) {
          files.splice(idx, 1);
          document.getElementById(`row-${id}`).remove();
        }
        if(files.length === 0) {
          fileList.innerHTML = ''; 
          processBtn.disabled = true;
        }
      };

      function updateProcessBtn() {
        processBtn.disabled = files.length === 0;
        processBtn.innerHTML = files.length > 0 ? `‚ú® Process ${files.length} Videos` : '‚ú® Start Auto-Crop Processing';
      }

      function log(msg) {
        logEl.innerHTML += `<div>> ${msg}</div>`;
        logEl.scrollTop = logEl.scrollHeight;
      }

      // --- Core Processing Logic ---

      async function initLibraries() {
        // Fix for "ReferenceError: FFmpegWASM is not defined"
        // We ensure window objects exist before accessing them
        if (!window.FFmpegWASM) {
          throw new Error('FFmpeg library failed to load. Please check your internet connection or disable ad-blockers.');
        }
        if (!window.FFmpegUtil) {
          throw new Error('FFmpeg Util library failed to load.');
        }
        
        FFmpeg = window.FFmpegWASM.FFmpeg;
        fetchFile = window.FFmpegUtil.fetchFile;
        toBlobURL = window.FFmpegUtil.toBlobURL;
      }

      async function loadFFmpeg() {
        if (ffmpeg) return;
        
        await initLibraries();
        log('Loading Processing Engine (FFmpeg)...');
        
        try {
          ffmpeg = new FFmpeg();
          const baseURL = 'https://unpkg.com/@ffmpeg/core@0.12.6/dist/umd';
          
          await ffmpeg.load({
            coreURL: await toBlobURL(`${baseURL}/ffmpeg-core.js`, 'text/javascript'),
            wasmURL: await toBlobURL(`${baseURL}/ffmpeg-core.wasm`, 'application/wasm'),
          });
          log('Engine Ready.');
        } catch(e) {
          log('Error loading engine: ' + e.message);
          alert('Could not load video engine. Please try Chrome or Edge.');
          throw e;
        }
      }

      async function loadFaceAPI() {
        if(!window.faceapi) return;
        try {
          log('Loading AI Models...');
          await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model/');
          log('AI Ready.');
        } catch(e) {
          log('AI Load Warning: ' + e.message);
        }
      }

      // Face Detection Helper
      async function detectFace(file) {
        return new Promise(async (resolve) => {
          const video = document.createElement('video');
          video.src = URL.createObjectURL(file);
          video.muted = true;
          
          // Timeout fallback
          const timeout = setTimeout(() => {
            log('Face detect timeout, using center.');
            resolve(null);
          }, 5000);

          video.onloadeddata = async () => {
            video.currentTime = Math.min(video.duration/2, 2); // Sample at 2s or middle
          };

          video.onseeked = async () => {
            try {
              const canvas = document.createElement('canvas');
              canvas.width = video.videoWidth;
              canvas.height = video.videoHeight;
              const ctx = canvas.getContext('2d');
              ctx.drawImage(video, 0, 0);
              
              if(window.faceapi) {
                 const detection = await faceapi.detectSingleFace(canvas, new faceapi.TinyFaceDetectorOptions());
                 clearTimeout(timeout);
                 if(detection) {
                   resolve({
                     x: detection.box.x + detection.box.width/2,
                     y: detection.box.y + detection.box.height/2,
                     w: video.videoWidth,
                     h: video.videoHeight
                   });
                   return;
                 }
              }
            } catch(e) { console.error(e); }
            
            clearTimeout(timeout);
            resolve(null); // Fallback to null (center)
          };
          
          video.onerror = () => { clearTimeout(timeout); resolve(null); };
        });
      }

      processBtn.onclick = async () => {
        processBtn.disabled = true;
        progressArea.style.display = 'block';
        resultsArea.innerHTML = ''; 
        
        const aspects = Array.from(document.querySelectorAll('.aspect-opt:checked')).map(cb => cb.value);
        if(aspects.length === 0) { alert('Select at least one aspect ratio'); processBtn.disabled = false; return; }

        const safeMode = document.getElementById('optSafeMode').checked;
        const zoom = document.getElementById('optZoom').checked;

        try {
          await loadFFmpeg();
          await loadFaceAPI();

          let processedCount = 0;
          const totalOps = files.length * aspects.length;

          for (const item of files) {
            log(`Processing: ${item.name}`);
            
            // 1. Detect Face
            let center = await detectFace(item.file);
            if(!center) {
              log('No face detected. Using center crop.');
              center = { x: 0, y: 0, w: 0, h: 0 }; 
            } else {
              log(`Face found at x:${Math.round(center.x)}`);
            }

            // 2. Write File to Memory
            const inputName = `input_${item.id}.mp4`;
            await ffmpeg.writeFile(inputName, await fetchFile(item.file));

            // 3. Process Each Aspect
            for(const aspect of aspects) {
              const outputName = `out_${item.id}_${aspect.replace(':','x')}.mp4`;
              const [tw, th] = aspect.split(':').map(Number);
              
              let cxStr = "(iw-ow)/2"; // Default Center
              if (center.w > 0) {
                 const normX = center.x / center.w;
                 cxStr = `(iw*${normX.toFixed(2)}) - (ow/2)`;
              }

              let cropFilter = "";
              if (tw/th < 1) { // Vertical (9:16)
                 cropFilter = `crop=w=ih*(${tw}/${th}):h=ih:x=${cxStr}:y=0`;
              } else {
                 cropFilter = `crop=w=iw:h=iw*(${th}/${tw}):x=0:y=(ih-oh)/2`;
              }

              let scaleFilter = safeMode ? ",scale=720:-2" : ""; 
              if (zoom) cropFilter += ",scale=iw*1.1:ih*1.1,crop=iw/1.1:ih/1.1"; 

              log(`Encoding ${aspect}...`);
              
              await ffmpeg.exec([
                '-i', inputName,
                '-vf', `${cropFilter}${scaleFilter}`,
                '-c:v', 'libx264',
                '-preset', 'superfast', 
                '-crf', '28', 
                '-c:a', 'copy', 
                outputName
              ]);

              const data = await ffmpeg.readFile(outputName);
              const blob = new Blob([data.buffer], { type: 'video/mp4' });
              
              addResult(blob, aspect, item.name);
              await ffmpeg.deleteFile(outputName);

              processedCount++;
              const pct = Math.round((processedCount / totalOps) * 100);
              progressBar.style.width = `${pct}%`;
              document.getElementById('progressPercent').textContent = `${pct}%`;
            }

            await ffmpeg.deleteFile(inputName);
          }
          
          log('All Done!');
          downloadAllBtn.disabled = false;
          progressText.textContent = "Completed!";
          progressBar.style.backgroundColor = "var(--success)";

        } catch(e) {
          log('Error: ' + e.message);
          alert('An error occurred. Check the log for details.');
          console.error(e);
        } finally {
          processBtn.disabled = false;
        }
      };

      function addResult(blob, ratio, origName) {
        const url = URL.createObjectURL(blob);
        const div = document.createElement('div');
        div.className = 'preview-card';
        
        div.innerHTML = `
          <video controls src="${url}"></video>
          <div class="preview-actions">
            <div style="font-size:11px; font-weight:600">${ratio}</div>
            <a href="${url}" download="cropx_${ratio}_${origName}" class="btn" style="padding:4px 10px; font-size:11px; height:auto;">Download</a>
          </div>
        `;
        resultsArea.appendChild(div);
      }

      downloadAllBtn.onclick = () => {
        document.querySelectorAll('.preview-actions a').forEach(a => a.click());
      };

    });
  </script>
</body>
</html>
